<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>GBE Mini v1.5.6 (Combi Sensor)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"/>
    <style>
      /* --- Base CSS --- */
      :root {
        --primary-color: #4c6ef5; --secondary-color: #3b5bdb; --success-color: #40c057;
        --danger-color: #fa5252; --warning-color: #fcc419; --info-color: #339af0;
        --light-bg: #f8f9fa; --dark-bg: #212529;
        --text-color: #212529; --border-radius: 8px; --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --card-bg: white; --border-color: #dee2e6; --icon-color: #868e96;
        --input-bg: white;
      }
      html[data-theme='dark'] {
        --primary-color: #748ffc; --secondary-color: #5c7cfa; --success-color: #69db7c;
        --danger-color: #ff8787; --warning-color: #ffd43b; --info-color: #66a8ff;
        --light-bg: #1a1b1e; --dark-bg: #101113;
        --text-color: #e9ecef; --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); --card-bg: #25262b;
        --border-color: #495057; --icon-color: #adb5bd;
        --input-bg: #343a40;
      }
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; padding: 0; background-color: var(--light-bg); color: var(--text-color); line-height: 1.6; transition: background-color 0.3s, color 0.3s; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
      .container { max-width: 900px; margin: 0 auto; padding: 20px; }
      header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
      .header-left { text-align: left; flex-grow: 1; }
      .header-right { flex-shrink: 0; display: flex; align-items: center; gap: 10px; }
      h1 { color: var(--primary-color); margin: 0 0 5px 0; font-size: 1.8rem; display: inline-flex; align-items: center; gap: 10px; }
      h1 .fa-leaf { color: var(--success-color); }
      header p { margin: 0; color: var(--icon-color); font-size: 0.95rem; }

      .theme-toggle { background: none; border: 1px solid var(--border-color); color: var(--text-color); font-size: 1.1rem; cursor: pointer; padding: 6px 10px; border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; transition: background-color 0.3s, border-color 0.3s; }
      .theme-toggle:hover { background-color: rgba(0, 0, 0, 0.05); }
      html[data-theme='dark'] .theme-toggle { border-color: var(--border-color); }
      html[data-theme='dark'] .theme-toggle:hover { background-color: rgba(255, 255, 255, 0.08); }

      .connection-widget { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 12px 15px; min-width: 220px; display: flex; flex-direction: column; gap: 8px; transition: background-color 0.3s, box-shadow 0.3s; }
      .connection-header { display: flex; justify-content: space-between; align-items: center; }
      .connection-title { font-size: 1rem; font-weight: 600; color: var(--primary-color); margin: 0; }

      .card { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 20px; transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s; }
      .card:not(:last-child) { margin-bottom: 20px; }

      .card-header { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
      .card-title { font-size: 1.3rem; font-weight: 600; color: var(--primary-color); margin: 0; display: inline-flex; align-items: center; gap: 8px; }
      .card-title i { font-size: 1.1em; opacity: 0.8; }

      .status-badge { padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
      .status-connected { background-color: var(--success-color); color: white; }
      .status-disconnected { background-color: #e9ecef; color: #495057; }
      html[data-theme='dark'] .status-disconnected { background-color: #495057; color: #ced4da; }

      button { background-color: var(--primary-color); color: white; border: none; padding: 10px 18px; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: background-color 0.2s, transform 0.1s ease-out; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
      button:hover { background-color: var(--secondary-color); }
      button:active { transform: scale(0.98); }
      button:disabled { background-color: #adb5bd; cursor: not-allowed; opacity: 0.7; }
      html[data-theme='dark'] button:disabled { background-color: #495057; }
      button i { line-height: 1; }
      .button-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }

      select, input[type="number"] { padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--input-bg); color: var(--text-color); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
      select:focus, input[type="number"]:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(76, 110, 245, 0.2); outline: none; }
      select { width: 100%; margin-bottom: 15px; }
      input[type="number"] { width: 65px; text-align: center; -moz-appearance: textfield; }
      input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

      .color-controls { margin-top: 20px; }
      .slider-group { margin-bottom: 15px; }
      .slider-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.9rem; }
      .slider-label span:first-child { font-weight: 600; color: var(--icon-color); }
      .slider-label span:last-child { font-weight: 600; color: var(--text-color); }
      input[type="range"] { width: 100%; -webkit-appearance: none; appearance: none; height: 8px; border-radius: 4px; background: #e9ecef; outline: none; transition: background 0.3s; }
      html[data-theme='dark'] input[type="range"] { background: #495057; }
      input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--primary-color); cursor: pointer; border: 3px solid var(--card-bg); box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: background 0.3s; }
      input[type="range"]::-moz-range-thumb { width: 14px; height: 14px; border-radius: 50%; background: var(--primary-color); cursor: pointer; border: 3px solid var(--card-bg); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
      .color-preview { width: 100%; height: 40px; border-radius: var(--border-radius); margin-bottom: 15px; border: 1px solid var(--border-color); background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; position: relative; overflow: hidden; }
      .color-preview-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; transition: background-color 0.1s; }

      .recipe-categories { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
      .category-btn { background-color: #e9ecef; color: #495057; padding: 6px 12px; border-radius: 16px; font-size: 0.85rem; border: none; cursor: pointer; transition: all 0.2s; font-weight: 500; }
      .category-btn.active { background-color: var(--primary-color); color: white; }
      html[data-theme='dark'] .category-btn { background-color: #343a40; color: #ced4da; }
      html[data-theme='dark'] .category-btn.active { background-color: var(--primary-color); color: white; }

      .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
      .recipe-item { background-color: var(--card-bg); border-radius: var(--border-radius); padding: 12px; cursor: pointer; transition: all 0.2s; text-align: center; border: 2px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
      html[data-theme='dark'] .recipe-item { box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
      .recipe-item:hover { transform: translateY(-3px); border-color: var(--secondary-color); background-color: rgba(76, 110, 245, 0.05); }
      .recipe-item.active { border-color: var(--primary-color); background-color: rgba(76, 110, 245, 0.1); box-shadow: 0 3px 6px rgba(76, 110, 245, 0.2); transform: translateY(-2px); }
      html[data-theme='dark'] .recipe-item:hover { background-color: rgba(116, 143, 252, 0.1); }
      html[data-theme='dark'] .recipe-item.active { background-color: rgba(116, 143, 252, 0.15); border-color: var(--primary-color); }
      .recipe-color { width: 36px; height: 36px; border-radius: 50%; margin: 0 auto 8px; box-shadow: inset 0 0 4px rgba(0,0,0,0.15); border: 1px solid rgba(0,0,0,0.1); }
      .recipe-name { font-size: 0.8rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; }

      .custom-recipes-title { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; margin-bottom: 10px; }
      .custom-recipes-title h2 { font-size: 1.3rem; color: var(--primary-color); margin: 0; }
      #clearRecipesBtn { background-color: var(--danger-color); }
      #clearRecipesBtn:hover { background-color: #e03131; }

      .recipes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
      .recipe-card { background-color: var(--card-bg); border-radius: var(--border-radius); padding: 15px; box-shadow: var(--card-shadow); display: flex; flex-direction: column; transition: transform 0.2s, background-color 0.3s; }
      .recipe-card:hover { transform: translateY(-3px); }
      .recipe-card .recipe-color { width: 40px; height: 40px; }
      .recipe-title { font-weight: 600; text-align: center; margin: 5px 0 8px 0; font-size: 0.9rem; }
      .recipe-text { font-size: 0.75rem; text-align: center; color: var(--icon-color); margin-bottom: 10px; word-break: break-all; }
      .recipe-buttons { display: flex; justify-content: center; margin-top: auto; gap: 8px; }
      .recipe-button { padding: 6px 10px; font-size: 0.8rem; border-radius: 6px; flex-grow: 1; }
      .recipe-button.delete-btn { background-color: var(--danger-color); }
      .recipe-button.delete-btn:hover { background-color: #e03131; }
      .no-recipes-msg { grid-column: 1 / -1; text-align: center; color: var(--icon-color); font-style: italic; margin: 20px 0; }

      .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(33, 37, 41, 0.9); color: white; padding: 10px 20px; border-radius: 6px; opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease, bottom 0.3s ease; z-index: 1000; text-align: center; min-width: 200px; max-width: 90%; box-shadow: 0 2px 10px rgba(0,0,0,0.2); pointer-events: none; font-size: 0.9rem; }
      .toast.show { opacity: 1; bottom: 30px; }
      html[data-theme='dark'] .toast { background: rgba(222, 226, 230, 0.9); color: #212529; }

      .spinner-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 1500; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s; }
      .spinner-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s; }
      .spinner-content { display: flex; flex-direction: column; align-items: center; }
      .spinner { width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
      .spinner-text { color: white; margin-top: 15px; font-weight: 500; font-size: 0.9rem; }

      footer { margin-top: 40px; text-align: center; color: var(--icon-color); font-size: 0.85rem; padding: 20px 0; border-top: 1px solid var(--border-color); } footer a { color: var(--primary-color); text-decoration: none; } footer a:hover { text-decoration: underline; }
      .pico-memory-display-footer { font-size: 0.8em; color: var(--icon-color); margin-top: 5px; margin-bottom: 10px; }
      .pico-memory-display-footer i { margin-right: 4px; }
      .pico-memory-display-footer span { font-weight: 600; color: var(--text-color); }

      .help-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s; padding: 20px; } .help-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s; }
      .help-dialog { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 25px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; }
      .help-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
      .help-header h2 { margin: 0; font-size: 1.4rem; color: var(--primary-color); }
      .help-close { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--icon-color); padding: 0; line-height: 1; transition: color 0.2s; }
      .help-close:hover { color: var(--danger-color); }
      .help-content h3 { margin-top: 20px; margin-bottom: 8px; color: var(--secondary-color); font-weight: 600;}
      .help-content h3 i { margin-right: 6px; opacity: 0.8; }
      .help-content ul { padding-left: 20px; margin-bottom: 15px; } .help-content li { margin-bottom: 8px; }
      .help-content code { background-color: rgba(0,0,0,0.05); padding: 2px 5px; border-radius: 4px; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; font-size: 0.9em; }
      html[data-theme='dark'] .help-content code { background-color: rgba(255,255,255,0.1); }

      .connected-device-info { display: flex; align-items: center; justify-content: space-between; gap: 5px; margin-bottom: 6px; min-height: 20px; }
      .connected-device-name-display { font-size: 0.85rem; color: var(--primary-color); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; flex-grow: 1; }
      .rename-widget-btn { padding: 4px 6px; background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 0.9rem; line-height: 1; border-radius: 4px; flex-shrink: 0; opacity: 0.7; transition: opacity 0.2s, background-color 0.2s; }
      .rename-widget-btn:hover { opacity: 1; background-color: rgba(0, 0, 0, 0.08); } html[data-theme='dark'] .rename-widget-btn:hover { background-color: rgba(255, 255, 255, 0.1); }
      .rename-widget-btn:disabled { color: #adb5bd; cursor: not-allowed; background-color: transparent; opacity: 0.5; }

      .schedule-setting-item { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
      .schedule-setting-item label { font-weight: 600; min-width: 100px; text-align: right; flex-shrink: 0; font-size: 0.95rem; }
      .schedule-setting-item select { padding: 10px; margin-bottom: 0; flex-grow: 1; max-width: 280px; min-width: 180px; }
      .schedule-time-inputs { display: flex; align-items: center; gap: 5px; }
      .schedule-time-inputs span { font-weight: bold; margin: 0 2px; color: var(--text-color); }
      .schedule-info { font-size: 0.9em; color: var(--icon-color); margin-top: 5px; padding-left: 110px; }
      html[data-theme='dark'] .schedule-info { color: #aaa; }
      .schedule-info.small-note { font-size: 0.8em; margin-top: 2px; }
      .pico-time-display { font-size: 0.85em; color: #555; margin-top: 5px; padding-left: 110px; min-height: 1.2em; }
      html[data-theme='dark'] .pico-time-display { color: #bbb; }

      .sensor-data-container {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
          gap: 15px;
          padding: 15px 0;
          margin-bottom: 15px;
      }
      .sensor-item { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 10px; background-color: rgba(0,0,0,0.02); border-radius: var(--border-radius); }
      html[data-theme='dark'] .sensor-item { background-color: rgba(255,255,255,0.05); }
      .sensor-item .sensor-icon { font-size: 1.6rem; color: var(--primary-color); margin-bottom: 6px; width: 32px; height: 32px; line-height: 32px; opacity: 0.9; }
      .sensor-item .sensor-display { min-height: 1.5em; }
      .sensor-item .sensor-value { font-size: 1.2rem; font-weight: 600; color: var(--text-color); line-height: 1.2; }
      .sensor-item .sensor-unit { font-size: 0.8rem; color: var(--icon-color); margin-left: 2px; }
      .sensor-item .sensor-value.error-text { color: var(--danger-color); font-weight: normal; font-size: 0.9em; }
      .sensor-card button#refreshSensorBtn { display: block; margin: 10px auto 0 auto; background-color: var(--secondary-color); }
      .sensor-card button#refreshSensorBtn:hover { background-color: var(--primary-color); }
      .sensor-card button#refreshSensorBtn:disabled { background-color: #adb5bd; }
      html[data-theme='dark'] .sensor-card button#refreshSensorBtn:disabled { background-color: #495057; }

      /* --- Temperature Toggle Styles --- */
      .sensor-label-container { display: flex; align-items: center; justify-content: center; gap: 5px; margin-top: 3px; }
      .sensor-label-container .sensor-label { margin: 0; font-size: 0.8rem; color: var(--icon-color); }
      .temp-unit-toggle { background: none; border: 1px solid var(--border-color); color: var(--primary-color); font-size: 0.75em; padding: 1px 4px; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background-color 0.2s, color 0.2s; line-height: 1; flex-shrink: 0; }
      .temp-unit-toggle:hover { background-color: var(--primary-color); color: white; }
      html[data-theme='dark'] .temp-unit-toggle:hover { background-color: var(--primary-color); color: var(--card-bg); }
      .temp-unit-toggle:disabled { opacity: 0.5; cursor: not-allowed; background-color: transparent !important; color: var(--icon-color) !important; border-color: var(--icon-color); }

      /* --- Enable Auto Cycle Button Style --- */
      #enableAutoCycleBtn { background-color: var(--success-color); }
      #enableAutoCycleBtn:hover { background-color: #37b24d; }
      html[data-theme='dark'] #enableAutoCycleBtn:hover { background-color: #51cf66; }
      #enableAutoCycleBtn:disabled { background-color: #adb5bd !important; } /* Ensure disabled style overrides */
      html[data-theme='dark'] #enableAutoCycleBtn:disabled { background-color: #495057 !important; }


      /* Media Queries */
      @media (max-width: 768px) {
        .container { padding: 15px; }
        header { flex-direction: column; align-items: stretch; }
        .header-left { text-align: center; }
        .header-right { width: 100%; justify-content: center; }
        .connection-widget { width: 100%; max-width: 320px; margin: 0 auto; }
        .button-group { justify-content: center; } /* Center buttons */
        .schedule-setting-item { justify-content: space-between; }
        .schedule-setting-item label { min-width: 80px; text-align: left; }
        .pico-time-display, .schedule-info { padding-left: 0; text-align: center; }
        .sensor-data-container { grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 15px; }
        .sensor-item .sensor-icon { font-size: 1.6rem; }
        .sensor-item .sensor-value { font-size: 1.2rem; }
      }
      @media (max-width: 480px) {
         h1 { font-size: 1.5rem; }
         header p { font-size: 0.9rem; }
         .card-title { font-size: 1.15rem; }
         .recipe-grid { grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 10px; }
         .recipe-item { padding: 10px; }
         .recipe-color { width: 30px; height: 30px; }
         .recipe-name { font-size: 0.75rem; }
         .recipes-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
         .schedule-setting-item { flex-direction: column; align-items: stretch; gap: 5px; }
         .schedule-setting-item label { text-align: left; margin-bottom: 2px; }
         .schedule-time-inputs { justify-content: flex-start; width: 100%; }
         .schedule-setting-item select { max-width: none; }
         .sensor-data-container { grid-template-columns: repeat(2, 1fr); gap: 10px; }
         .sensor-item { flex-direction: column; padding: 8px; }
         .sensor-item > div { text-align: center; }
         .sensor-label-container { justify-content: center; }
         .sensor-item .sensor-label { margin-top: 0; }
         .sensor-item .sensor-icon { margin-bottom: 4px; }
         .sensor-item .sensor-value { font-size: 1.1rem; }
      }
       @media (max-width: 360px) {
           .sensor-data-container { grid-template-columns: 1fr; }
           .sensor-item { flex-direction: row; justify-content: space-between; align-items: center; padding: 8px 12px; }
           .sensor-item > div { text-align: left; flex-grow: 1;}
           .sensor-label-container { justify-content: flex-start; }
           .sensor-item .sensor-icon { margin-bottom: 0; margin-right: 8px; }
       }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="header-left">
             <h1><i class="fa-solid fa-leaf"></i> GBE Mini</h1>
             <p>Growth Chamber control, schedule & sensor monitoring via Bluetooth.</p>
        </div>
         <div class="header-right">
             <button id="themeToggle" class="theme-toggle" title="Toggle dark/light mode"><i class="fa-solid fa-moon"></i></button>
             <div class="connection-widget">
                <div class="connection-header">
                    <h3 class="connection-title">Connection</h3>
                    <span id="connectionStatus" class="status-badge status-disconnected">Offline</span>
                </div>
                <div id="connectedDeviceInfo" class="connected-device-info" style="display: none;">
                    <div id="connectedDeviceName" class="connected-device-name-display">Device Name</div>
                    <button id="renameConnectedDeviceBtn" class="rename-widget-btn" title="Rename Connected Device" disabled>
                        <i class="fa-solid fa-pencil"></i>
                    </button>
                </div>
                <button id="connectButton" style="width: 100%; margin-top: 5px;"><i class="fa-brands fa-bluetooth-b"></i> Connect</button>
             </div>
        </div>
    </header>

    <!-- Environmental Sensor Card -->
    <div class="card sensor-card">
        <div class="card-header">
            <h2 class="card-title"><i class="fa-solid fa-temperature-half"></i> Environmental Sensors</h2>
        </div>
        <p class="schedule-info small-note" style="text-align: center; padding: 0 0 15px 0;">Sensor availability determined by Pico config. Data sent via Combined Sensor characteristic.</p>
        <div class="sensor-data-container">
            <!-- Temperature -->
            <div class="sensor-item">
                <i class="fa-solid fa-temperature-three-quarters sensor-icon"></i>
                <div>
                    <div class="sensor-display">
                        <span class="sensor-value" id="sensorTemp">---</span>
                        <span class="sensor-unit" id="sensorTempUnit">°C</span>
                    </div>
                    <div class="sensor-label-container">
                        <div class="sensor-label">Temperature</div>
                        <button id="tempUnitToggle" class="temp-unit-toggle" title="Switch to Fahrenheit">°F</button>
                    </div>
                </div>
            </div>
            <!-- Humidity -->
            <div class="sensor-item">
                <i class="fa-solid fa-droplet sensor-icon"></i>
                 <div>
                    <div class="sensor-display">
                        <span class="sensor-value" id="sensorHumid">---</span>
                        <span class="sensor-unit">%</span>
                    </div>
                    <div class="sensor-label">Humidity</div>
                </div>
            </div>
            <!-- CO2 -->
            <div class="sensor-item">
                 <i class="fa-solid fa-smog sensor-icon"></i>
                 <div>
                    <div class="sensor-display">
                        <span class="sensor-value" id="sensorCO2">---</span>
                        <span class="sensor-unit">ppm</span>
                    </div>
                    <div class="sensor-label">CO₂ Level</div>
                </div>
            </div>
            <!-- Pressure -->
            <div class="sensor-item">
                 <i class="fa-solid fa-gauge-high sensor-icon"></i>
                 <div>
                    <div class="sensor-display">
                        <span class="sensor-value" id="sensorPressure">---</span>
                        <span class="sensor-unit">hPa</span>
                    </div>
                    <div class="sensor-label">Pressure</div>
                </div>
            </div>
            <!-- Illuminance -->
            <div class="sensor-item">
                 <i class="fa-solid fa-sun sensor-icon"></i>
                 <div>
                    <div class="sensor-display">
                        <span class="sensor-value" id="sensorLux">---</span>
                        <span class="sensor-unit">lux</span>
                    </div>
                    <div class="sensor-label">Light Level</div>
                </div>
            </div>
        </div>
        <button id="refreshSensorBtn" disabled><i class="fa-solid fa-arrows-rotate"></i> Refresh Sensor Data</button>
    </div>

    <!-- Light Recipes Card -->
    <div class="card">
        <div class="card-header"><h2 class="card-title"><i class="fa-solid fa-palette"></i> Light Recipes</h2></div>
        <div class="recipe-categories">
            <button class="category-btn active" data-category="all">All</button>
            <button class="category-btn" data-category="basic">Basic</button>
            <button class="category-btn" data-category="plant">Plants</button>
            <button class="category-btn" data-category="mood">Mood</button>
        </div>
        <div class="recipe-grid" id="recipeGrid"> <!-- Populated by JS --> </div>
    </div>

    <!-- Manual On/Off Card -->
    <div class="card">
        <div class="card-header"><h2 class="card-title"><i class="fa-solid fa-power-off"></i> Manual Control</h2></div>
        <div style="display:flex; gap:10px; flex-wrap: wrap;">
            <button id="lightsOnBtn" style="flex:1;" disabled><i class="fa-solid fa-lightbulb"></i> Lights ON (Auto Recipe)</button>
            <button id="lightsOffBtn" style="flex:1;" disabled><i class="fa-solid fa-toggle-off"></i> Lights OFF</button>
        </div>
         <p class="schedule-info small-note" style="text-align: center; padding: 10px 0 0 0;">(Turns off auto-cycle if active)</p>
    </div>

    <!-- Auto-Cycle & Time Settings Card -->
    <div class="card">
        <div class="card-header"> <h2 class="card-title"><i class="fa-solid fa-clock"></i> Auto-Cycle Schedule</h2> </div>
        <p class="schedule-info" style="padding-left:0; text-align: center; margin-bottom: 15px;">Configure the daily ON/OFF times and the recipe used when turning ON automatically.</p>
        <div class="schedule-setting-item">
            <label for="onHourInput">Turn ON Time:</label>
            <div class="schedule-time-inputs"><input type="number" id="onHourInput" min="0" max="23" value="8" disabled aria-label="ON Hour"/><span>:</span><input type="number" id="onMinuteInput" min="0" max="59" value="0" disabled aria-label="ON Minute"/></div>
        </div>
        <div class="schedule-setting-item">
            <label for="offHourInput">Turn OFF Time:</label>
            <div class="schedule-time-inputs"><input type="number" id="offHourInput" min="0" max="23" value="20" disabled aria-label="OFF Hour"/><span>:</span><input type="number" id="offMinuteInput" min="0" max="59" value="0" disabled aria-label="OFF Minute"/></div>
        </div>
        <div class="schedule-setting-item">
            <label for="activeRecipeSelect">Auto ON Recipe:</label>
            <select id="activeRecipeSelect" disabled aria-label="Active ON Recipe"><option value="" disabled selected>Loading...</option></select>
        </div>
        <div class="button-group" style="margin-top: 20px; justify-content: center;">
            <button id="applyScheduleBtn" disabled><i class="fa-solid fa-floppy-disk"></i> Save Times</button>
            <button id="setActiveRecipeBtn" disabled><i class="fa-solid fa-star"></i> Set Auto Recipe</button>
            <button id="enableAutoCycleBtn" disabled style="background-color: var(--success-color);"><i class="fa-solid fa-calendar-check"></i> Enable Auto-Cycle</button>
            <button id="syncTimeBtn" disabled style="background-color: var(--secondary-color);"><i class="fa-solid fa-sync-alt"></i> Sync Pico Time</button>
            <button id="requestSettingsBtn" disabled><i class="fa-solid fa-cloud-arrow-down"></i> Refresh Status</button>
        </div>
        <p id="scheduleStatus" class="schedule-info" style="margin-top: 15px; text-align: center;">Connect device to manage settings.</p>
        <p id="picoTimeDisplay" class="pico-time-display" style="margin-top: 10px;">Pico Time: (Connect and Refresh)</p>
    </div>

    <!-- Custom Color Card -->
    <div class="card">
        <div class="card-header"><h2 class="card-title"><i class="fa-solid fa-sliders"></i> Custom Color</h2></div>
        <div class="color-preview"><div id="colorPreviewOverlay" class="color-preview-overlay"></div></div>
        <div class="color-controls">
            <div class="slider-group"><div class="slider-label"><span>Red</span><span id="redValue">0</span></div><input type="range" id="redSlider" min="0" max="255" value="0" disabled aria-label="Red slider"/></div>
            <div class="slider-group"><div class="slider-label"><span>Green</span><span id="greenValue">0</span></div><input type="range" id="greenSlider" min="0" max="255" value="0" disabled aria-label="Green slider"/></div>
            <div class="slider-group"><div class="slider-label"><span>Blue</span><span id="blueValue">0</span></div><input type="range" id="blueSlider" min="0" max="255" value="0" disabled aria-label="Blue slider"/></div>
            <div class="slider-group"><div class="slider-label"><span>White</span><span id="whiteValue">0</span></div><input type="range" id="whiteSlider" min="0" max="255" value="0" disabled aria-label="White slider"/></div>
        </div>
        <div class="button-group" style="justify-content: center;">
            <button id="applyCustomColor" disabled><i class="fa-solid fa-paint-brush"></i> Apply Color</button>
            <button id="saveRecipeBtn" disabled style="background-color: var(--success-color);"><i class="fa-solid fa-save"></i> Save as Recipe</button>
        </div>
        <p class="schedule-info small-note" style="text-align: center; padding: 10px 0 0 0;">(Applying turns off auto-cycle)</p>
    </div>

    <!-- My Custom Recipes Section -->
    <div class="custom-recipes-title">
        <h2>My Custom Recipes</h2>
        <button id="clearRecipesBtn" disabled><i class="fa-solid fa-trash-can"></i> Clear All</button>
    </div>
    <div class="card">
        <div class="recipes-grid" id="customRecipesGrid">
            <p class="no-recipes-msg">You have no saved custom recipes yet.</p>
             <!-- Populated by JS -->
        </div>
    </div>


    <!-- Footer -->
    <footer>
         <p id="picoMemoryDisplayFooter" class="pico-memory-display-footer">
              <i class="fa-solid fa-memory"></i> Pico Mem Free: <span>---</span>
         </p>
         <p>PicoLight Controller | <a href="#" id="showHelp">Help</a> | <a href="https://github.com/mariocruz/" target="_blank" rel="noopener noreferrer">GitHub</a></p>
    </footer>
</div> <!-- End Container -->

<!-- UI Feedback Elements -->
<div class="toast" id="toast">Toast Message Here</div>
<div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner-content">
        <div class="spinner"></div>
        <div class="spinner-text" id="spinnerText">Processing...</div>
    </div>
</div>

<!-- Help Dialog -->
<div class="help-overlay" id="helpOverlay">
    <div class="help-dialog">
        <div class="help-header"><h2>PicoLight Controller Help</h2><button class="help-close" id="closeHelp" aria-label="Close help dialog">×</button></div>
        <div class="help-content">
             <h3><i class="fa-solid fa-bluetooth-b"></i> Connection</h3>
            <ul>
                <li>Click "Connect" (<i class="fa-brands fa-bluetooth-b"></i>). Select your "PicoLightSen" device.</li>
                <li>Click "Disconnect" (<i class="fa-solid fa-unlink"></i>) to end session.</li>
                <li>Click (<i class="fa-solid fa-pencil"></i>) to give device a nickname (stored in browser).</li>
                <li>Pico's free RAM shown in footer after connect/refresh.</li>
                <li>The page attempts to use the Screen Wake Lock API to prevent the display (and potentially system) from sleeping while connected and the tab is visible. This helps maintain the connection but is not guaranteed if you switch tabs or the OS overrides it.</li>
            </ul>
            <h3><i class="fa-solid fa-temperature-half"></i> Environmental Sensors</h3>
            <ul>
                <li>Sensor availability depends on Pico's `config.py`.</li>
                <li>All sensor data (Temp, Hum, CO2, Pressure, Lux) is now sent via a single "Combined Sensor Data" characteristic (UUID `a1b2...` unless changed) within the main Light Service (`19b1...`).</li>
                <li>Values should update automatically via BLE Notifications from this combined characteristic.</li>
                <li>Click the `°F`/`°C` button next to Temperature to toggle units (preference saved in browser).</li>
                <li>Clicking "Refresh Sensor Data" (<i class="fa-solid fa-arrows-rotate"></i>) forces a read of this single combined characteristic.</li>
                <li>"N/A" means sensor disabled/unavailable on Pico or value not yet received/parsed. "Error", "ParseErr", "ReadErr" indicate a communication or parsing problem. Check browser console (F12 -> Console) for details.</li>
            </ul>
             <h3><i class="fa-solid fa-palette"></i> Light Control</h3>
             <ul>
                <li><b>Recipes:</b> Click preset icon. Use category filters.</li>
                <li><b>Custom:</b> Use sliders, then "Apply Color" (<i class="fa-solid fa-paint-brush"></i>).</li>
                <li><b>Manual:</b> "Lights ON" (<i class="fa-solid fa-lightbulb"></i>) uses "Auto ON Recipe". "Lights OFF" (<i class="fa-solid fa-toggle-off"></i>) turns lights off.</li>
                <li><b>Save:</b> Click "Save as Recipe" (<i class="fa-solid fa-save"></i>) for custom color. Apply (<i class="fa-solid fa-play"></i>) or Delete (<i class="fa-solid fa-trash-can"></i>) from "My Custom Recipes".</li>
                 <li>Lux is also available via its own characteristic (`f8a3...`) if needed for direct reading/notify, but is included in the combined string.</li>
                <li><i class="fa-solid fa-triangle-exclamation" style="color: var(--warning-color);"></i> Applying any manual light setting disables Auto-Cycle.</li>
            </ul>
            <h3><i class="fa-solid fa-clock"></i> Auto-Cycle Schedule</h3>
            <ul>
                <li>Set <b>ON/OFF Times</b> (HH:MM). Click "Save Times" (<i class="fa-solid fa-floppy-disk"></i>).</li>
                <li>Select <b>Auto ON Recipe</b> (not 'Off'). Click "Set Auto Recipe" (<i class="fa-solid fa-star"></i>).</li>
                <li>If Auto-Cycle is off (e.g., after manual control), click "Enable Auto-Cycle" (<i class="fa-solid fa-calendar-check"></i>) to turn it back on. The button will be disabled when auto-cycle is active.</li>
                <li>Click "Sync Pico Time" (<i class="fa-solid fa-sync-alt"></i>) to match Pico clock to browser.</li>
                <li>Click "Refresh Status" (<i class="fa-solid fa-cloud-arrow-down"></i>) for current settings/time/memory/auto-cycle state.</li>
                <li>Pico's time shown after sync/refresh. Auto-cycle status shown in status text below buttons (e.g., "(Auto: ON)").</li>
            </ul>
             <p><b>Note:</b> Auto-cycle runs based on Pico's state, toggled off by manual commands.</p>
            <h3><i class="fa-solid fa-circle-question"></i> Troubleshooting</h3>
            <ul>
                <li><b>Connection Drops:</b> Ensure device is in range. Check OS Power Settings (disable USB suspend, prevent Bluetooth sleep). Keep the browser tab visible (browsers often freeze background tabs). The Wake Lock API helps but isn't foolproof.</li>
                <li><b>Connection (General):</b> Check Pico power/code. Bluetooth/Location ON. Grant browser permissions. Refresh page. Restart Pico.</li>
                <li><b>Commands:</b> Check browser console (F12 -> Console). Refresh page. Reconnect.</li>
                 <li><b>Sensor Data "Error"/"---"/"ParseErr"/"ReadErr":</b> Check Pico `config.py` flags & sensor wiring. Check Pico serial output. Ensure the Combined Sensor UUID (`a1b2...`) matches between Pico and Web UI. Check console for specific errors (e.g., "NotFoundError" if combined char isn't found, or parsing errors).</li>
                <li><b>Schedule:</b> "Refresh Status". Check "Enable Auto-Cycle" button state. "Sync Pico Time". Check Pico logs.</li>
                <li><b>Memory Low:</b> Pico may be unstable. Reduce logging/features if needed.</li>
            </ul><hr><p style="text-align:center; font-size: 0.9em;">PicoLight Controller Web UI</p>
        </div>
    </div>
</div>

<script>
    // --- Constants and Configuration ---
    const SERVICE_UUID = "19b10000-e8f2-537e-4f6c-d104768a1214"; // Custom Light Service
    const RECIPE_CHAR_UUID = "19b10001-e8f2-537e-4f6c-d104768a1214";
    const CUSTOM_CHAR_UUID = "19b10002-e8f2-537e-4f6c-d104768a1214";
    const CONTROL_CHAR_UUID = "19b10003-e8f2-537e-4f6c-d104768a1214";
    const ILLUMINANCE_CHAR_UUID = "f8a3b2c1-d4e5-4f67-8a9b-c1d2e3f4a501"; // Custom UUID (under Light Svc)
    // *** Combined Sensor Characteristic UUID (MUST MATCH config.py) ***
    const COMBINED_SENSOR_CHAR_UUID = "a1b2c3d4-e5f6-4789-a0b1-c2d3e4f5a601"; // Replace with your generated UUID
    const TEMP_UNIT_PREF_KEY = 'picolight-temp-unit'; // Key for localStorage

    const recipes = ["balanced","warm","cool","daylight","veg_growth","bloom","seedling","succulent","purple_glow","sunrise","sunset","forest","aquarium","night_light","inspection","off"];
    const recipeColors = { balanced:"rgb(255,64,128)",warm:"rgb(255,140,20)",cool:"rgb(180,200,255)",daylight:"rgb(255,230,210)",veg_growth:"rgb(50,255,70)",bloom:"rgb(255,100,10)",seedling:"rgb(100,100,200)",succulent:"rgb(220,180,40)",purple_glow:"rgb(180,0,255)",sunrise:"rgb(255,50,20)",sunset:"rgb(255,30,0)",forest:"rgb(30,200,30)",aquarium:"rgb(0,200,255)",night_light:"rgb(50,20,0)",inspection:"rgb(255,255,255)",off:"rgb(50,50,50)" };
    const recipeCategories = { balanced:"basic",warm:"basic",cool:"basic",daylight:"basic",inspection:"basic",night_light:"basic",off:"basic",veg_growth:"plant",bloom:"plant",seedling:"plant",succulent:"plant",forest:"plant",purple_glow:"mood",sunrise:"mood",sunset:"mood",aquarium:"mood" };

    // Command Codes
    const CMD_SET_OFF = 0, CMD_SET_ON_ACTIVE_RECIPE = 1, CMD_TOGGLE_AUTO_CYCLE = 2; // Toggle used for Enable button
    const CMD_REQUEST_SETTINGS = 12, CMD_SET_ACTIVE_RECIPE_IDX = 13, CMD_SET_ON_TIME = 14, CMD_SET_OFF_TIME = 15;
    const CMD_REQUEST_STATUS = 20, CMD_SET_RTC_TIME = 30;

    // Notification Codes
    const NTF_ACK_COMMAND_RECEIVED = 100, NTF_ERROR_INVALID_COMMAND = 101, NTF_AUTO_CYCLE_ENABLED = 102, NTF_AUTO_CYCLE_DISABLED = 103;
    const NTF_SETTINGS_UPDATE = 113, NTF_STATUS_UPDATE = 120, NTF_MEMORY_UPDATE = 121, NTF_TIME_UPDATE = 131;

    // --- Global Variables ---
    let bleDevice = null, bleServer = null;
    let recipeCharacteristic = null, customCharacteristic = null, controlCharacteristic = null;
    let illuminanceCharacteristic = null;
    let combinedSensorCharacteristic = null;
    let customRecipes = [], savedDevices = [];
    let connectInProgress = false;
    let currentTempUnit = 'C';
    let wakeLock = null;
    let isAutoCycleEnabled = false; // Track Auto-Cycle state

    // --- DOM Element References ---
    const connectButton = document.getElementById("connectButton");
    const connectionStatus = document.getElementById("connectionStatus");
    const connectedDeviceInfo = document.getElementById('connectedDeviceInfo');
    const connectedDeviceName = document.getElementById('connectedDeviceName');
    const renameConnectedDeviceBtn = document.getElementById('renameConnectedDeviceBtn');
    const recipeGrid = document.getElementById("recipeGrid");
    const colorPreviewOverlay = document.getElementById("colorPreviewOverlay");
    const redSlider = document.getElementById("redSlider"), greenSlider = document.getElementById("greenSlider"), blueSlider = document.getElementById("blueSlider"), whiteSlider = document.getElementById("whiteSlider");
    const redValue = document.getElementById("redValue"), greenValue = document.getElementById("greenValue"), blueValue = document.getElementById("blueValue"), whiteValue = document.getElementById("whiteValue");
    const applyCustomColor = document.getElementById("applyCustomColor");
    const saveRecipeBtn = document.getElementById("saveRecipeBtn");
    const customRecipesGrid = document.getElementById("customRecipesGrid");
    const clearRecipesBtn = document.getElementById("clearRecipesBtn");
    const onHourInput = document.getElementById('onHourInput'), onMinuteInput = document.getElementById('onMinuteInput');
    const offHourInput = document.getElementById('offHourInput'), offMinuteInput = document.getElementById('offMinuteInput');
    const activeRecipeSelect = document.getElementById('activeRecipeSelect');
    const applyScheduleBtn = document.getElementById('applyScheduleBtn'), setActiveRecipeBtn = document.getElementById('setActiveRecipeBtn');
    const requestSettingsBtn = document.getElementById('requestSettingsBtn'), syncTimeBtn = document.getElementById('syncTimeBtn');
    const enableAutoCycleBtn = document.getElementById('enableAutoCycleBtn'); // Ref for new button
    const scheduleStatus = document.getElementById('scheduleStatus'), picoTimeDisplay = document.getElementById('picoTimeDisplay');
    const lightsOnBtn = document.getElementById("lightsOnBtn"), lightsOffBtn = document.getElementById("lightsOffBtn");
    const toastElement = document.getElementById("toast"), spinnerOverlay = document.getElementById('spinnerOverlay'), spinnerText = document.getElementById('spinnerText');
    const themeToggle = document.getElementById("themeToggle"), showHelpBtn = document.getElementById("showHelp"), helpOverlay = document.getElementById("helpOverlay"), closeHelpBtn = document.getElementById("closeHelp");
    const sensorTempDisplay = document.getElementById('sensorTemp');
    const sensorTempUnit = document.getElementById('sensorTempUnit');
    const tempUnitToggle = document.getElementById('tempUnitToggle');
    const sensorHumidDisplay = document.getElementById('sensorHumid');
    const sensorCO2Display = document.getElementById('sensorCO2');
    const sensorPressureDisplay = document.getElementById('sensorPressure');
    const sensorLuxDisplay = document.getElementById('sensorLux');
    const refreshSensorBtn = document.getElementById('refreshSensorBtn');
    const picoMemoryDisplayFooter = document.getElementById('picoMemoryDisplayFooter').querySelector('span');

    // --- Utility Functions ---
    async function retryBleOperation(operation, operationName = 'BLE Operation', maxAttempts = 2, delayMs = 300) {
        let lastError;
        for (let attempt = 1; attempt <= maxAttempts; attempt++) {
            try { return await operation(); }
            catch (error) {
                console.warn(`${operationName} attempt ${attempt}/${maxAttempts} failed:`, error.name, error.message);
                lastError = error;
                if (error.name === 'NotFoundError' || error.name === 'NotAllowedError' || error.name === 'NotSupportedError') break;
                if (attempt < maxAttempts) { await new Promise(resolve => setTimeout(resolve, delayMs)); }
            }
        }
        console.error(`${operationName} failed after ${maxAttempts} attempts.`); throw lastError;
    }
    function initialize() { console.log("PicoLight UI Initializing..."); savedDevices = loadSavedDevices(); customRecipes = loadCustomRecipes(); loadThemePreference(); loadTempUnitPreference(); populateRecipeGrid(); populateActiveRecipeSelect(); displayCustomRecipes(); setupEventListeners(); disableUIControls(); checkBluetoothSupport(); console.log("Initialization Complete."); }
    function checkBluetoothSupport() { if (!navigator.bluetooth) { showToast("Web Bluetooth API not supported!", 10000); connectButton.disabled = true; connectButton.innerHTML = '<i class="fa-solid fa-times-circle"></i> No BT Support'; } }
    function populateActiveRecipeSelect() { activeRecipeSelect.innerHTML='<option value="" disabled selected>Select Recipe...</option>'; recipes.forEach((n, i) => { if (n !== 'off') { const o=document.createElement("option"); o.value=i; o.textContent=n.replace(/_/g," ").replace(/\b\w/g, l=>l.toUpperCase()); activeRecipeSelect.appendChild(o); } }); }
    function setupEventListeners() {
        connectButton.addEventListener("click", attemptConnect);
        renameConnectedDeviceBtn.addEventListener('click', handleRenameConnectedDevice);
        themeToggle.addEventListener("click", toggleTheme);
        showHelpBtn.addEventListener("click", e=>{e.preventDefault(); showHelp();});
        closeHelpBtn.addEventListener("click", closeHelp);
        helpOverlay.addEventListener("click", e=>{if(e.target===helpOverlay)closeHelp();});
        lightsOnBtn.addEventListener("click", sendLightsOn);
        lightsOffBtn.addEventListener("click", sendLightsOff);
        const tpu = throttle(updateColorPreview, 50);
        [redSlider, greenSlider, blueSlider, whiteSlider].forEach(s=>s.addEventListener("input", tpu));
        applyCustomColor.addEventListener("click", applyCustomColorHandler);
        saveRecipeBtn.addEventListener("click", saveCustomRecipe);
        clearRecipesBtn.addEventListener("click", clearCustomRecipes);
        applyScheduleBtn.addEventListener('click', applyScheduleTimeHandler);
        setActiveRecipeBtn.addEventListener('click', setActiveRecipeHandler);
        requestSettingsBtn.addEventListener('click', requestCurrentStatusAndSettings);
        syncTimeBtn.addEventListener('click', sendTimeToPico);
        enableAutoCycleBtn.addEventListener('click', enableAutoCycleHandler); // Listener for Enable Auto Cycle
        onHourInput.addEventListener('input',()=>validateTimeInput(onHourInput,23));
        onMinuteInput.addEventListener('input',()=>validateTimeInput(onMinuteInput,59));
        offHourInput.addEventListener('input',()=>validateTimeInput(offHourInput,23));
        offMinuteInput.addEventListener('input',()=>validateTimeInput(offMinuteInput,59));
        refreshSensorBtn.addEventListener('click', readSensorData);
        tempUnitToggle.addEventListener('click', toggleTemperatureUnit);
        document.addEventListener('visibilitychange', handleVisibilityChange); // Listener for Wake Lock re-acquire
    }
    function validateTimeInput(el, max) { try { if(el.value==='')return; let v=parseInt(el.value); if(isNaN(v)){el.value=''; return;} if(v<0)el.value=0; if(v>max)el.value=max;}catch(e){console.error("Time validation error:",e);el.value=(max===23)?8:0;}}
    function disableUIControls() {
        document.querySelectorAll("button, input, select").forEach(el => {
             // Ensure the temp toggle AND enable auto cycle are included here
             if (!['themeToggle', 'showHelp', 'closeHelp', 'connectButton', 'tempUnitToggle', 'enableAutoCycleBtn'].includes(el.id)) {
                 el.disabled = true;
             }
        });
        tempUnitToggle.disabled = true;
        enableAutoCycleBtn.disabled = true; // Disable initially
        renameConnectedDeviceBtn.disabled = true;
        refreshSensorBtn.disabled = true;
        displayTemperature(null, true); // Reset temp display
        updateSensorDisplay(sensorHumidDisplay, '---', '%');
        updateSensorDisplay(sensorCO2Display, '---', 'ppm');
        updateSensorDisplay(sensorPressureDisplay, '---', 'hPa');
        updateSensorDisplay(sensorLuxDisplay, '---', 'lux');
        scheduleStatus.textContent = "Connect device to manage settings.";
        picoTimeDisplay.textContent = "Pico Time: (Offline)";
        picoMemoryDisplayFooter.textContent = '---';
        activeRecipeSelect.value = "";
        resetColorSliders();
        connectButton.innerHTML = '<i class="fa-brands fa-bluetooth-b"></i> Connect';
        connectButton.disabled = !navigator.bluetooth;
        connectedDeviceInfo.style.display = 'none';
        connectionStatus.textContent = "Offline";
        connectionStatus.className = "status-badge status-disconnected";
        document.querySelectorAll('.recipe-card .recipe-button:not(.delete-btn)').forEach(btn => btn.disabled = true);
        connectInProgress = false;
        isAutoCycleEnabled = false; // Reset state
    }
    function enableUIControls() {
        if (bleDevice && bleDevice.gatt.connected) {
            document.querySelectorAll("button, input, select").forEach(el => {
                if (!['themeToggle', 'showHelp', 'closeHelp', 'enableAutoCycleBtn'].includes(el.id)) { // Exclude enable button initially
                    el.disabled = false;
                }
            });
            // Specific handling for Enable button based on state
            enableAutoCycleBtn.disabled = isAutoCycleEnabled;
            tempUnitToggle.disabled = false; // Enable C/F toggle
            connectButton.innerHTML = '<i class="fa-solid fa-unlink"></i> Disconnect';
            connectButton.disabled = false;
            renameConnectedDeviceBtn.disabled = false;
            clearRecipesBtn.disabled = (customRecipes.length === 0);
            refreshSensorBtn.disabled = false;
            connectedDeviceInfo.style.display = 'flex';
            connectionStatus.textContent = "Connected";
            connectionStatus.className = "status-badge status-connected";
            document.querySelectorAll('.recipe-card .recipe-button:not(.delete-btn)').forEach(btn => btn.disabled = false);
        } else {
            disableUIControls(); // Fallback if not connected
        }
        // Ensure these are always enabled
        themeToggle.disabled = false;
        showHelpBtn.disabled = false;
    }
    function resetColorSliders() { redSlider.value=0; greenSlider.value=0; blueSlider.value=0; whiteSlider.value=0; updateColorPreview(); }
    function toggleTheme(){ const cT=document.documentElement.getAttribute('data-theme'); const nT=cT==='dark'?'light':'dark'; document.documentElement.setAttribute('data-theme',nT); themeToggle.innerHTML=nT==='dark'?'<i class="fa-solid fa-sun"></i>':'<i class="fa-solid fa-moon"></i>'; themeToggle.title=`Switch to ${nT==='dark'?'light':'dark'} mode`; localStorage.setItem('picolight-theme',nT); }
    function loadThemePreference(){ const sT=localStorage.getItem('picolight-theme')||'light'; document.documentElement.setAttribute('data-theme',sT); themeToggle.innerHTML=sT==='dark'?'<i class="fa-solid fa-sun"></i>':'<i class="fa-solid fa-moon"></i>'; themeToggle.title=`Switch to ${sT==='dark'?'light':'dark'} mode`; }
    function showHelp(){helpOverlay.classList.add('active');} function closeHelp(){helpOverlay.classList.remove('active');}
    function showSpinner(msg="Processing..."){spinnerText.textContent=msg; spinnerOverlay.classList.add("active");} function hideSpinner(){spinnerOverlay.classList.remove("active");}
    function showToast(msg,dur=3000){toastElement.textContent=msg; toastElement.className="toast show"; setTimeout(()=>{toastElement.className="toast";}, dur);}
    function throttle(func, limit){let iT;return function(){const a=arguments,c=this;if(!iT){func.apply(c,a);iT=true;setTimeout(()=>iT=false,limit);}}}
    function formatTime(h,m){return`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;}
    function formatDateTime(y,mo,d,h,mi,s,wdJS){const dys=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];const wdS=(wdJS>=0&&wdJS<7)?dys[wdJS]:"???";return`${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')} (${wdS}) ${String(h).padStart(2,'0')}:${String(mi).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
    function loadSavedDevices(){const d=localStorage.getItem('picolight-saved-devices');try{return d?JSON.parse(d):[];}catch(e){console.error("LS Error parsing devices:",e);localStorage.removeItem('picolight-saved-devices');return[];}}
    function findSavedDeviceById(id){return savedDevices.find(d=>d.id===id);}
    function getDeviceDisplayName(dId){const d=findSavedDeviceById(dId);return d?(d.customName||d.name||'PicoLight Device'):'Unknown Device';}
    function promptForDeviceName(dId){const d=findSavedDeviceById(dId);if(!d)return;const cN=d.customName||d.name||'';const nN=prompt("Enter custom nickname:",cN);if(nN!==null){const tN=nN.trim();if(tN){d.customName=tN;try{localStorage.setItem('picolight-saved-devices',JSON.stringify(savedDevices));if(bleDevice&&bleDevice.id===dId){connectedDeviceName.textContent=tN;}showToast(`Renamed to "${tN}"`);}catch(e){console.error("LS Error saving name:",e);showToast("Could not save nickname.");}}else{showToast("Nickname empty.");}}}
    function handleRenameConnectedDevice(){if(!bleDevice||!bleDevice.gatt.connected)return showToast("Not connected."); promptForDeviceName(bleDevice.id);}
    function saveDeviceToMemory(d, lightUUID){const dI={id:d.id,name:d.name||'PicoLight',customName:(findSavedDeviceById(d.id)?.customName)||(d.name||'PicoLight'),lightServiceUUID:lightUUID, lastConnected:new Date().toISOString()};const idx=savedDevices.findIndex(dev=>dev.id===d.id);if(idx>=0){savedDevices[idx]={...savedDevices[idx],...dI};}else{savedDevices.push(dI);}try{localStorage.setItem('picolight-saved-devices',JSON.stringify(savedDevices));localStorage.setItem('picolight-last-device',d.id);}catch(e){console.error("LS Error saving device:",e);showToast("Could not save device info.");}}
    function loadTempUnitPreference() { const savedUnit = localStorage.getItem(TEMP_UNIT_PREF_KEY); currentTempUnit = (savedUnit === 'F') ? 'F' : 'C'; console.log(`Temperature unit preference loaded: ${currentTempUnit}`); updateTempToggleButtonVisuals(); }
    function updateTempToggleButtonVisuals() { if (!tempUnitToggle || !sensorTempUnit) return; if (currentTempUnit === 'C') { tempUnitToggle.textContent = '°F'; tempUnitToggle.title = 'Switch to Fahrenheit'; } else { tempUnitToggle.textContent = '°C'; tempUnitToggle.title = 'Switch to Celsius'; } sensorTempUnit.textContent = `°${currentTempUnit}`; }
    function toggleTemperatureUnit() { currentTempUnit = (currentTempUnit === 'C') ? 'F' : 'C'; localStorage.setItem(TEMP_UNIT_PREF_KEY, currentTempUnit); console.log(`Temperature unit switched to: ${currentTempUnit}`); updateTempToggleButtonVisuals(); const currentRawCelsius = sensorTempDisplay.dataset.rawValueC; if (currentRawCelsius !== undefined && currentRawCelsius !== null && !isNaN(parseFloat(currentRawCelsius))) { try { displayTemperature(parseFloat(currentRawCelsius)); } catch(e) { console.error("Error re-displaying temperature after toggle:", e); displayTemperature(null); } } else { sensorTempUnit.textContent = `°${currentTempUnit}`; } }
    function celsiusToFahrenheit(celsius) { if (celsius === null || typeof celsius !== 'number' || isNaN(celsius)) return null; return (celsius * 9 / 5) + 32; }
    async function requestWakeLock() { if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release', () => { console.log('Screen Wake Lock released unexpectedly.'); wakeLock = null; }); console.log('Screen Wake Lock is active.'); showToast('Screen Wake Lock active', 2000); } catch (err) { console.error(`Wake Lock failed: ${err.name}, ${err.message}`); wakeLock = null; } } else { console.warn('Wake Lock API not supported.'); } }
    function releaseWakeLock() { if (wakeLock !== null && wakeLock.released === false) { wakeLock.release().then(() => { console.log('Screen Wake Lock released manually.'); wakeLock = null; }).catch((err) => { console.error(`Wake Lock release failed: ${err.name}, ${err.message}`); }); } }
    async function handleVisibilityChange() { if (wakeLock === null && document.visibilityState === 'visible' && bleDevice && bleDevice.gatt.connected) { console.log("Tab became visible, attempting to re-acquire Wake Lock..."); await requestWakeLock(); } else if (document.visibilityState !== 'visible' && wakeLock !== null) { console.log("Tab hidden, Wake Lock may be released by browser."); } }

    // --- Bluetooth Connection & Communication ---
    function attemptConnect(){ if(connectInProgress)return showToast("Connection attempt in progress..."); if(bleDevice&&bleDevice.gatt.connected){console.log("Disconnecting...");showSpinner("Disconnecting..."); releaseWakeLock(); bleDevice.gatt.disconnect();}else{startDeviceDiscovery();} }
    async function startDeviceDiscovery(){ if(!navigator.bluetooth){showToast("Web Bluetooth not available.",5000);return;} console.log("Requesting BT device..."); connectInProgress=true; showSpinner("Waiting for device selection..."); try{ const d=await navigator.bluetooth.requestDevice({ filters:[{namePrefix:'PicoLightSen'}], optionalServices:[SERVICE_UUID] }); console.log("Device selected:",d.name,d.id); bleDevice=d; await connectToSelectedDevice(); }catch(e){ console.error("BT selection/conn error:",e); hideSpinner(); let m=`BT Error: ${e.message}`; if(e.name==='NotFoundError'){m="No compatible PicoLight device selected or found. Ensure ON & advertising.";}else if(e.name==='NotAllowedError'){m="Bluetooth access denied. Check permissions.";} showToast(m,5000); if(!bleDevice||!bleDevice.gatt.connected){onDisconnected();} }finally{connectInProgress=false;} }
    async function connectToSelectedDevice(){
        if(!bleDevice)throw new Error("No device selected.");
        const dDN=getDeviceDisplayName(bleDevice.id);
        console.log(`Connecting to ${dDN} (${bleDevice.id})...`);
        showSpinner(`Connecting to ${dDN}...`);
        bleDevice.removeEventListener("gattserverdisconnected",onDisconnected);
        bleDevice.addEventListener("gattserverdisconnected",onDisconnected);
        try{
            console.log("Connecting GATT...");
            bleServer=await bleDevice.gatt.connect();
            console.log("GATT Connected.");
            recipeCharacteristic = null; customCharacteristic = null; controlCharacteristic = null;
            illuminanceCharacteristic = null; combinedSensorCharacteristic = null;
            console.log("Getting Light Service & Characteristics...");
            const lS=await bleServer.getPrimaryService(SERVICE_UUID);
            const lightCharPromises = [ lS.getCharacteristic(RECIPE_CHAR_UUID).catch(e => { console.warn("Recipe char discovery failed:", e.name); return null; }), lS.getCharacteristic(CUSTOM_CHAR_UUID).catch(e => { console.warn("Custom char discovery failed:", e.name); return null; }), lS.getCharacteristic(CONTROL_CHAR_UUID).catch(e => { console.warn("Control char discovery failed:", e.name); return null; }), lS.getCharacteristic(ILLUMINANCE_CHAR_UUID).catch(e => { console.warn("Illuminance char discovery failed:", e.name); return null; }), lS.getCharacteristic(COMBINED_SENSOR_CHAR_UUID).catch(e => { console.warn("Combined Sensor char discovery failed:", e.name); return null; }) ];
            const lightResults = await Promise.allSettled(lightCharPromises);
            recipeCharacteristic = lightResults[0].status === 'fulfilled' ? lightResults[0].value : null;
            customCharacteristic = lightResults[1].status === 'fulfilled' ? lightResults[1].value : null;
            controlCharacteristic = lightResults[2].status === 'fulfilled' ? lightResults[2].value : null;
            illuminanceCharacteristic = lightResults[3].status === 'fulfilled' ? lightResults[3].value : null;
            combinedSensorCharacteristic = lightResults[4].status === 'fulfilled' ? lightResults[4].value : null;
            if(recipeCharacteristic) console.log("-> Recipe Char OK"); if(customCharacteristic) console.log("-> Custom Char OK"); if(controlCharacteristic) console.log("-> Control Char OK"); if(illuminanceCharacteristic) console.log("-> Illuminance Char OK"); if(combinedSensorCharacteristic) console.log("-> Combined Sensor Char OK");
            if (!controlCharacteristic || !controlCharacteristic.properties.notify) { throw new Error("Control characteristic unusable."); }
            console.log("Starting Control Notifications...");
            await controlCharacteristic.startNotifications();
            controlCharacteristic.removeEventListener('characteristicvaluechanged', handleControlNotification);
            controlCharacteristic.addEventListener('characteristicvaluechanged', handleControlNotification);
            controlCharacteristic.listening = true;
            console.log("Control Notifications OK.");
            if (combinedSensorCharacteristic && combinedSensorCharacteristic.properties.notify) { console.log("Starting Combined Sensor Notifications..."); await combinedSensorCharacteristic.startNotifications(); combinedSensorCharacteristic.removeEventListener('characteristicvaluechanged', handleCombinedSensorNotification); combinedSensorCharacteristic.addEventListener('characteristicvaluechanged', handleCombinedSensorNotification); combinedSensorCharacteristic.listening = true; console.log("-> Combined Sensor Notifications Started."); } else { console.warn("-> Combined Sensor characteristic missing or does not support notify."); }
            saveDeviceToMemory(bleDevice, SERVICE_UUID);
            connectedDeviceName.textContent=dDN;
            isAutoCycleEnabled = false; // Assume disabled until status is confirmed
            enableUIControls(); // Enable buttons, will set EnableAuto based on isAutoCycleEnabled
            await requestWakeLock();
            showToast(`Connected to ${dDN}`);
            hideSpinner();
            requestCurrentStatusAndSettings(); // Get initial state including auto-cycle
            await readSensorData();
        } catch(e){console.error("BT Conn Error:",e);hideSpinner();showToast(`Conn failed: ${e.message}`,5000); releaseWakeLock(); if(bleDevice&&bleDevice.gatt.connected){bleDevice.gatt.disconnect();}else{onDisconnected();}throw e;}
    }

    // --- Sensor Data Processing Functions ---
    function displayTemperature(celsiusValue, forceResetText = false) { if (!sensorTempDisplay || !sensorTempUnit) return; if (forceResetText) { sensorTempDisplay.textContent = '---'; sensorTempDisplay.classList.remove('error-text'); sensorTempDisplay.removeAttribute('data-raw-value-c'); sensorTempUnit.textContent = `°${currentTempUnit}`; return; } if (celsiusValue === null || typeof celsiusValue !== 'number' || isNaN(celsiusValue)) { sensorTempDisplay.textContent = 'N/A'; sensorTempDisplay.classList.add('error-text'); sensorTempDisplay.removeAttribute('data-raw-value-c'); sensorTempUnit.textContent = `°${currentTempUnit}`; } else { sensorTempDisplay.dataset.rawValueC = celsiusValue.toFixed(2); sensorTempDisplay.classList.remove('error-text'); let displayValue; if (currentTempUnit === 'F') { const fahrenheitValue = celsiusToFahrenheit(celsiusValue); displayValue = fahrenheitValue !== null ? fahrenheitValue.toFixed(1) : 'Err'; sensorTempUnit.textContent = '°F'; } else { displayValue = celsiusValue.toFixed(1); sensorTempUnit.textContent = '°C'; } sensorTempDisplay.textContent = displayValue; } updateTempToggleButtonVisuals(); }
    function updateSensorDisplay(element, valueStr, unit) { if (!element) return; if (element.id === 'sensorTemp') return; const unitSpan = element.nextElementSibling; if (valueStr === null || valueStr === undefined || valueStr.trim() === "" || valueStr.toUpperCase() === "N/A" || valueStr.toUpperCase() === "READING...") { element.textContent = (valueStr !== null && valueStr.toUpperCase() === "READING...") ? 'Reading...' : 'N/A'; element.classList.toggle('error-text', valueStr !== null && valueStr.toUpperCase() !== "READING..."); if (unitSpan && unitSpan.classList.contains('sensor-unit')) unitSpan.textContent = ''; } else { const numValue = parseFloat(valueStr); if (!isNaN(numValue)) { if (element.id === 'sensorHumid') { element.textContent = numValue.toFixed(1); } else if (element.id === 'sensorPressure') { element.textContent = numValue.toFixed(0); } else if (element.id === 'sensorCO2' || element.id === 'sensorLux') { element.textContent = numValue.toFixed(0); } else { element.textContent = valueStr; } element.classList.remove('error-text'); if (unitSpan && unitSpan.classList.contains('sensor-unit')) unitSpan.textContent = unit; } else { element.textContent = 'ParseErr'; element.classList.add('error-text'); if (unitSpan && unitSpan.classList.contains('sensor-unit')) unitSpan.textContent = ''; console.warn(`Could not parse sensor value: "${valueStr}" for element ${element.id}`); } } }
    function showParsingErrorOnAllSensors(message = 'ParseErr') { if (sensorTempDisplay && sensorTempUnit) { sensorTempDisplay.textContent = message; sensorTempDisplay.classList.add('error-text'); sensorTempUnit.textContent = `°${currentTempUnit}`; sensorTempDisplay.removeAttribute('data-raw-value-c'); } updateSensorDisplay(sensorHumidDisplay, message, ''); updateSensorDisplay(sensorCO2Display, message, ''); updateSensorDisplay(sensorPressureDisplay, message, ''); updateSensorDisplay(sensorLuxDisplay, message, ''); }
    function handleCombinedSensorNotification(event) { const value = event.target.value; if (event.target.uuid !== COMBINED_SENSOR_CHAR_UUID) return; try { const decoder = new TextDecoder('utf-8'); const sensorString = decoder.decode(value); const parts = sensorString.split(','); if (parts.length === 5) { const tempStr = parts[0]; const tempC = (tempStr === null || tempStr.toUpperCase() === 'N/A' || tempStr.trim() === '') ? null : parseFloat(tempStr); displayTemperature(isNaN(tempC) ? null : tempC); updateSensorDisplay(sensorHumidDisplay, parts[1], '%'); updateSensorDisplay(sensorCO2Display, parts[2], 'ppm'); updateSensorDisplay(sensorPressureDisplay, parts[3], 'hPa'); updateSensorDisplay(sensorLuxDisplay, parts[4], 'lux'); } else { console.error(`Combined sensor notify string parts error (${parts.length}): "${sensorString}"`); showParsingErrorOnAllSensors('FormatErr'); } } catch (e) { console.error(`Error processing combined sensor notify:`, e); showParsingErrorOnAllSensors('ParseErr'); } }

    // --- Control Characteristic Notification Handler ---
    function handleControlNotification(evt){
        const v=evt.target.value; if(!v||v.byteLength===0) return;
        const dV=new DataView(v.buffer); const nC=dV.getUint8(0); const pL=v.byteLength-1;
        console.log(`Control Notify RX - Code:${nC}, Len:${v.byteLength}`);
        try{
            switch(nC){
                case NTF_SETTINGS_UPDATE:
                    if(pL>=5){ const onH=dV.getUint8(1),onM=dV.getUint8(2),offH=dV.getUint8(3),offM=dV.getUint8(4),aRI=dV.getUint8(5); console.log(`Settings RX: ON=${formatTime(onH,onM)}, OFF=${formatTime(offH,offM)}, RecipeIdx=${aRI}`); onHourInput.value=onH;onMinuteInput.value=onM;offHourInput.value=offH;offMinuteInput.value=offM; activeRecipeSelect.value=aRI; const rN=(aRI>=0&&aRI<recipes.length)?recipes[aRI]:'Unknown'; let currentStatusText = `Sched: ON ${formatTime(onH,onM)}, OFF ${formatTime(offH,offM)} | Auto Recipe: ${rN.replace(/_/g," ")}`; scheduleStatus.textContent = currentStatusText; /* Status will be updated by auto-cycle notify if it follows */ enableUIControls(); hideSpinner(); showToast("Pico settings updated"); } // Refresh UI state after settings update
                    else{console.warn(`Incomplete Settings notify. Len:${v.byteLength}`);}
                    break;
                case NTF_AUTO_CYCLE_ENABLED:
                    console.log("Auto Cycle ENABLED notify received.");
                    isAutoCycleEnabled = true;
                    scheduleStatus.textContent = scheduleStatus.textContent.replace(/ \(Auto: (ON|OFF)\)|$/, '') + " (Auto: ON)";
                    if (bleDevice && bleDevice.gatt.connected) { enableAutoCycleBtn.disabled = true; }
                    hideSpinner(); showToast("Auto Cycle Enabled");
                    break;
                case NTF_AUTO_CYCLE_DISABLED:
                    console.log("Auto Cycle DISABLED notify received.");
                    isAutoCycleEnabled = false;
                    scheduleStatus.textContent = scheduleStatus.textContent.replace(/ \(Auto: (ON|OFF)\)|$/, '') + " (Auto: OFF)";
                    if (bleDevice && bleDevice.gatt.connected) { enableAutoCycleBtn.disabled = false; }
                    hideSpinner(); showToast("Auto Cycle Disabled");
                    break;
                case NTF_STATUS_UPDATE:
                    if(pL>=4){ const r=dV.getUint8(1),g=dV.getUint8(2),b=dV.getUint8(3),w=dV.getUint8(4); redSlider.value=r;greenSlider.value=g;blueSlider.value=b;whiteSlider.value=w; updateColorPreview(); }
                    else{console.warn(`Incomplete Color Status notify. Len:${v.byteLength}`);}
                    break;
                case NTF_MEMORY_UPDATE:
                    if(pL>=4){ const mB=dV.getUint32(1,true); picoMemoryDisplayFooter.textContent=`${(mB/1024).toFixed(1)} KB`; }
                    else{console.warn(`Incomplete Memory notify. Len:${v.byteLength}`);picoMemoryDisplayFooter.textContent='Error';}
                    break;
                case NTF_TIME_UPDATE:
                    if(pL>=8){ const y=dV.getUint16(1,true),mo=dV.getUint8(3),d=dV.getUint8(4),h=dV.getUint8(5),mi=dV.getUint8(6),s=dV.getUint8(7),wdJS=dV.getUint8(8); picoTimeDisplay.textContent=`Pico Time: ${formatDateTime(y,mo,d,h,mi,s,wdJS)}`; hideSpinner(); showToast("Pico time updated/confirmed"); }
                    else{console.warn(`Incomplete Time notify. Len:${v.byteLength}`);}
                    break;
                case NTF_ERROR_INVALID_COMMAND: console.error("Invalid Command notify from Pico."); showToast("Error: Pico reported invalid command.",4000); hideSpinner(); break;
                default: console.log(`Unhandled control notify code: ${nC}`); break;
            }
        }catch(e){console.error("Error processing control notify:",e,evt); showToast("Error processing device update."); hideSpinner();}
    }

    function onDisconnected(evt){
        const dN=bleDevice?getDeviceDisplayName(bleDevice.id):'Device';
        console.log(`${dN} disconnected.`);
        releaseWakeLock(); // Release wake lock
        isAutoCycleEnabled = false; // Reset state
        if(bleDevice){try{bleDevice.removeEventListener("gattserverdisconnected",onDisconnected);}catch(e){}}
        const stopNotify = async (char, handler) => { if (char) { try { if (char.listening) { await char.stopNotifications(); char.listening = false; console.log(`Stopped notifications for ${char.uuid}`); } char.removeEventListener('characteristicvaluechanged', handler); } catch(e) { if (e.name !== 'NetworkError' && e.name !== 'InvalidStateError') { console.warn(`Error stopping notifications/listener for ${char.uuid}:`, e.name); } } } };
        stopNotify(controlCharacteristic, handleControlNotification);
        stopNotify(combinedSensorCharacteristic, handleCombinedSensorNotification);
        stopNotify(illuminanceCharacteristic, handleCombinedSensorNotification); // Although likely unused
        bleDevice=null; bleServer=null; recipeCharacteristic=null; customCharacteristic=null; controlCharacteristic=null;
        illuminanceCharacteristic = null; combinedSensorCharacteristic = null;
        hideSpinner(); disableUIControls(); showToast(`${dN} disconnected`);
    }

    // --- Recipe, Color, Commands ---
    function populateRecipeGrid(){ recipeGrid.innerHTML=""; recipes.forEach((rN,idx)=>{ const cat=recipeCategories[rN]||"basic"; const item=document.createElement("div"); item.className="recipe-item"; item.dataset.category=cat; item.dataset.recipeIndex=idx; item.title=`Apply ${rN.replace(/_/g," ")}`; const clrDiv=document.createElement("div"); clrDiv.className="recipe-color"; clrDiv.style.backgroundColor=recipeColors[rN]||"#888"; const nameDiv=document.createElement("div"); nameDiv.className="recipe-name"; nameDiv.textContent=rN.replace(/_/g," ").replace(/\b\w/g,l=>l.toUpperCase()); item.addEventListener("click",()=>{if(!bleDevice||!bleDevice.gatt.connected)return showToast("Not connected."); applyPresetRecipe(idx,rN);}); item.appendChild(clrDiv); item.appendChild(nameDiv); recipeGrid.appendChild(item); }); initCategoryFilter(); }
    function initCategoryFilter(){ const btns=document.querySelectorAll(".category-btn"); btns.forEach(b=>{b.addEventListener("click",function(){btns.forEach(btn=>btn.classList.remove("active"));this.classList.add("active"); filterRecipesByCategory(this.dataset.category);});}); filterRecipesByCategory('all'); }
    function filterRecipesByCategory(cat){ document.querySelectorAll("#recipeGrid .recipe-item").forEach(item=>{item.style.display=(cat==="all"||item.dataset.category===cat)?"":"none";}); }
    async function applyPresetRecipe(idx,name){ if(!recipeCharacteristic)return showToast("Not connected or recipe char missing."); const dN=name.replace(/_/g," "); console.log(`Applying preset: ${dN} (Idx:${idx})`); showSpinner(`Applying ${dN}...`); document.querySelectorAll("#recipeGrid .recipe-item").forEach(item=>item.classList.toggle("active",parseInt(item.dataset.recipeIndex)===idx)); resetColorSliders(); try{ await recipeCharacteristic.writeValue(new Uint8Array([idx])); setTimeout(()=>{hideSpinner();showToast(`Applied: ${dN}`);},300); /* Pico should send NTF_AUTO_CYCLE_DISABLED */ }catch(e){console.error("Error applying preset:",e);hideSpinner();showToast(`Failed recipe: ${e.message}`); document.querySelectorAll("#recipeGrid .recipe-item.active").forEach(item=>item.classList.remove("active"));} }
    function updateColorPreview(){ try{ const r=parseInt(redSlider.value),g=parseInt(greenSlider.value),b=parseInt(blueSlider.value),w=parseInt(whiteSlider.value); redValue.textContent=r; greenValue.textContent=g; blueValue.textContent=b; whiteValue.textContent=w; const dR=Math.min(255,r+Math.round(w/3)),dG=Math.min(255,g+Math.round(w/3)),dB=Math.min(255,b+Math.round(w/3)); colorPreviewOverlay.style.backgroundColor=`rgb(${dR},${dG},${dB})`; document.querySelectorAll("#recipeGrid .recipe-item.active").forEach(item=>item.classList.remove("active")); }catch(e){console.error("Err update preview:",e);} }
    async function applyCustomColorHandler(){ if(!customCharacteristic)return showToast("Not connected or custom char missing."); const r=parseInt(redSlider.value),g=parseInt(greenSlider.value),b=parseInt(blueSlider.value),w=parseInt(whiteSlider.value); console.log(`Applying custom: R=${r} G=${g} B=${b} W=${w}`); showSpinner("Applying custom color..."); document.querySelectorAll("#recipeGrid .recipe-item.active").forEach(item=>item.classList.remove("active")); try{ await customCharacteristic.writeValue(new Uint8Array([r,g,b,w])); setTimeout(()=>{hideSpinner();showToast("Custom color applied");},300); /* Pico should send NTF_AUTO_CYCLE_DISABLED */ }catch(e){console.error("Error applying custom:",e);hideSpinner();showToast(`Failed color: ${e.message}`);} }
    async function sendCommand(cmdCode,payload=null){ if(!controlCharacteristic){showToast("Cmd Error: Not connected.");return Promise.reject(new Error("Not Connected"));} console.log(`Sending Cmd:${cmdCode}, Payload:`,payload); let dTS; if(payload instanceof Uint8Array||payload instanceof ArrayBuffer){const pB=new Uint8Array(payload);dTS=new Uint8Array(1+pB.byteLength);dTS[0]=cmdCode;dTS.set(pB,1);}else if(Array.isArray(payload)){dTS=new Uint8Array(1+payload.length);dTS[0]=cmdCode;dTS.set(payload,1);}else if(payload===null||payload===undefined){dTS=new Uint8Array([cmdCode]);}else{return Promise.reject(new Error("Invalid payload type"));} console.log("Writing control:",dTS); try{await controlCharacteristic.writeValueWithResponse(dTS); console.log(`Cmd ${cmdCode} sent.`); return Promise.resolve();}catch(e){console.error(`Error sending cmd ${cmdCode}:`,e); showToast(`Cmd Failed: ${e.message}`); return Promise.reject(e);}}
    function sendLightsOn(){ showSpinner("Turning Lights ON..."); sendCommand(CMD_SET_ON_ACTIVE_RECIPE).then(()=>{setTimeout(()=>{if(spinnerOverlay.classList.contains('active'))hideSpinner();showToast("Lights ON cmd sent");},1500); /* Pico should send NTF_AUTO_CYCLE_DISABLED */ }).catch(e=>{hideSpinner();}); }
    function sendLightsOff(){ showSpinner("Turning Lights OFF..."); sendCommand(CMD_SET_OFF).then(()=>{ document.querySelectorAll("#recipeGrid .recipe-item.active").forEach(i=>i.classList.remove("active")); const oI=recipes.indexOf('off'); if(oI>=0){document.querySelector(`#recipeGrid .recipe-item[data-recipe-index="${oI}"]`)?.classList.add('active');} resetColorSliders(); setTimeout(()=>{hideSpinner();showToast("Lights OFF cmd sent");},300); /* Pico should send NTF_AUTO_CYCLE_DISABLED */ }).catch(e=>{hideSpinner();}); }

    // --- Custom Recipes (Local Storage) ---
    function saveCustomRecipe(){ const r=parseInt(redSlider.value),g=parseInt(greenSlider.value),b=parseInt(blueSlider.value),w=parseInt(whiteSlider.value); const n=prompt("Recipe name:","My Light"); if(!n||!n.trim())return showToast("Name empty."); const nR={name:n.trim(),r,g,b,w,id:Date.now()}; customRecipes.push(nR); saveCustomRecipesToStorage(); displayCustomRecipes(); showToast(`Recipe "${nR.name}" saved.`); }
    function clearCustomRecipes(){ if(customRecipes.length===0)return showToast("No recipes."); if(confirm("Delete ALL custom recipes?")){customRecipes=[];saveCustomRecipesToStorage();displayCustomRecipes();showToast("Custom recipes cleared.");} }
    function displayCustomRecipes(){ customRecipesGrid.innerHTML=""; clearRecipesBtn.disabled=(customRecipes.length===0); if(customRecipes.length===0){customRecipesGrid.innerHTML='<p class="no-recipes-msg">No saved recipes.</p>';return;} customRecipes.forEach(r=>{const card=document.createElement("div");card.className="recipe-card"; const clrDiv=document.createElement("div");clrDiv.className="recipe-color"; const dR=Math.min(255,r.r+Math.round(r.w/3)),dG=Math.min(255,r.g+Math.round(r.w/3)),dB=Math.min(255,r.b+Math.round(r.w/3)); clrDiv.style.backgroundColor=`rgb(${dR},${dG},${dB})`; const titDiv=document.createElement("div");titDiv.className="recipe-title";titDiv.textContent=r.name; const txtDiv=document.createElement("div");txtDiv.className="recipe-text";txtDiv.textContent=`R:${r.r} G:${r.g} B:${r.b} W:${r.w}`; const btnsDiv=document.createElement("div");btnsDiv.className="recipe-buttons"; const appBtn=document.createElement("button");appBtn.className="recipe-button";appBtn.innerHTML='<i class="fa-solid fa-play"></i> Apply';appBtn.title=`Apply ${r.name}`; appBtn.disabled=!(bleDevice&&bleDevice.gatt.connected); appBtn.addEventListener("click",()=>applyCustomRecipe(r)); const delBtn=document.createElement("button");delBtn.className="recipe-button delete-btn";delBtn.innerHTML='<i class="fa-solid fa-trash-can"></i> Del';delBtn.title=`Delete ${r.name}`; delBtn.addEventListener("click",()=>deleteCustomRecipe(r.id)); btnsDiv.appendChild(appBtn);btnsDiv.appendChild(delBtn); card.appendChild(clrDiv);card.appendChild(titDiv);card.appendChild(txtDiv);card.appendChild(btnsDiv); customRecipesGrid.appendChild(card);}); }
    async function applyCustomRecipe(r){ if(!customCharacteristic)return showToast("Not connected or custom char missing."); console.log(`Applying custom recipe: ${r.name}`); showSpinner(`Applying ${r.name}...`); redSlider.value=r.r;greenSlider.value=r.g;blueSlider.value=r.b;whiteSlider.value=r.w; updateColorPreview(); document.querySelectorAll("#recipeGrid .recipe-item.active").forEach(item=>item.classList.remove("active")); try{ await customCharacteristic.writeValue(new Uint8Array([r.r,r.g,r.b,r.w])); setTimeout(()=>{hideSpinner();showToast(`Applied: ${r.name}`);},300); /* Pico should send NTF_AUTO_CYCLE_DISABLED */ }catch(e){console.error("Error apply custom recipe:",e);hideSpinner();showToast(`Failed apply recipe: ${e.message}`);} }
    function deleteCustomRecipe(rId){ const idx=customRecipes.findIndex(r=>r.id===rId); if(idx===-1)return; const rN=customRecipes[idx].name; if(confirm(`Delete recipe "${rN}"?`)){customRecipes.splice(idx,1);saveCustomRecipesToStorage();displayCustomRecipes();showToast(`Recipe "${rN}" deleted.`);} }
    function loadCustomRecipes(){ const sD=localStorage.getItem("picoLightCustomRecipes"); try{return sD?JSON.parse(sD):[];}catch(e){console.error("LS Error parsing recipes:",e);localStorage.removeItem("picoLightCustomRecipes");return[];} }
    function saveCustomRecipesToStorage(){ try{localStorage.setItem("picoLightCustomRecipes",JSON.stringify(customRecipes));}catch(e){console.error("LS Error saving recipes:",e);showToast("Could not save recipes.");} }

    // --- Schedule & Time ---
    async function applyScheduleTimeHandler(){ if(!controlCharacteristic)return showToast("Not connected."); let onH=parseInt(onHourInput.value),onM=parseInt(onMinuteInput.value),offH=parseInt(offHourInput.value),offM=parseInt(offMinuteInput.value); if(isNaN(onH)||onH<0||onH>23)return showToast("Invalid ON hour."); if(isNaN(onM)||onM<0||onM>59)return showToast("Invalid ON minute."); if(isNaN(offH)||offH<0||offH>23)return showToast("Invalid OFF hour."); if(isNaN(offM)||offM<0||offM>59)return showToast("Invalid OFF minute."); console.log(`Sending schedule: ON=${formatTime(onH,onM)}, OFF=${formatTime(offH,offM)}`); showSpinner("Saving schedule times..."); try{ await sendCommand(CMD_SET_ON_TIME,[onH,onM]); await new Promise(r=>setTimeout(r,150)); await sendCommand(CMD_SET_OFF_TIME,[offH,offM]); setTimeout(()=>{if(spinnerOverlay.classList.contains('active'))hideSpinner();showToast(`Schedule times sent`);},2500); /* Pico should send NTF_SETTINGS_UPDATE */ }catch(e){hideSpinner();showToast(`Failed save times: ${e.message||'Comm error'}`);} }
    async function setActiveRecipeHandler(){ if(!controlCharacteristic)return showToast("Not connected."); const selIdx=parseInt(activeRecipeSelect.value); if(isNaN(selIdx)||activeRecipeSelect.value===""||selIdx<0||selIdx>=recipes.length||recipes[selIdx]==='off'){return showToast("Select valid recipe (not 'Off').");} const rN=recipes[selIdx]; const dN=rN.replace(/_/g," "); console.log(`Setting Auto Recipe: ${dN} (Idx:${selIdx})`); showSpinner(`Setting Auto Recipe to ${dN}...`); try{ await sendCommand(CMD_SET_ACTIVE_RECIPE_IDX,[selIdx]); setTimeout(()=>{if(spinnerOverlay.classList.contains('active'))hideSpinner();showToast(`Auto ON Recipe selection sent`);},2500); /* Pico should send NTF_SETTINGS_UPDATE */ }catch(e){hideSpinner();showToast(`Failed set auto recipe: ${e.message||'Comm error'}`);} }
    async function enableAutoCycleHandler() {
        if (!controlCharacteristic) return showToast("Not connected.");
        console.log("Attempting to enable Auto-Cycle by sending Toggle command...");
        showSpinner("Enabling Auto-Cycle...");
        sendCommand(CMD_TOGGLE_AUTO_CYCLE)
            .then(() => {
                console.log("Toggle Auto-Cycle command sent (for enabling).");
                setTimeout(() => { if (spinnerOverlay.classList.contains('active')) { hideSpinner(); if (!isAutoCycleEnabled) { showToast("Enable command sent, check Pico status.", 3000); } } }, 2500);
            })
            .catch(e => { hideSpinner(); showToast(`Failed to enable Auto-Cycle: ${e.message}`); });
    }
    function requestCurrentStatusAndSettings(){
        if(!controlCharacteristic)return showToast("Cannot refresh: Not connected.");
        console.log("Requesting settings (schedule, recipe idx, memory, time, auto-cycle state)...");
        scheduleStatus.textContent="Requesting...";
        picoTimeDisplay.textContent="Pico Time: Requesting...";
        picoMemoryDisplayFooter.textContent='Requesting...';
        enableAutoCycleBtn.disabled = true; // Disable button while requesting
        showSpinner("Requesting status...");
        sendCommand(CMD_REQUEST_SETTINGS)
         .then(()=>{
            console.log("Settings request cmd sent.");
            setTimeout(()=>{ // Timeout if no notifications received
                 if(spinnerOverlay.classList.contains('active')){
                    hideSpinner(); showToast("Status requested. Check Pico if no update.",4000);
                    scheduleStatus.textContent="Request timed out."; picoTimeDisplay.textContent="Pico Time: Request timed out."; picoMemoryDisplayFooter.textContent = 'Timeout';
                    if (bleDevice && bleDevice.gatt.connected) { enableAutoCycleBtn.disabled = isAutoCycleEnabled; } // Re-enable based on last known state
                 }
             },4000);
         })
         .catch(e=>{
             hideSpinner(); scheduleStatus.textContent="Request Failed."; picoTimeDisplay.textContent="Pico Time: Request Failed."; picoMemoryDisplayFooter.textContent = 'Request Error';
             if (bleDevice && bleDevice.gatt.connected) { enableAutoCycleBtn.disabled = false; } // Default to enabled if request fails
         });
    }
    async function sendTimeToPico(){ if(!controlCharacteristic)return showToast("Not connected."); const now=new Date(),yr=now.getFullYear(),mo=now.getMonth()+1,d=now.getDate(),h=now.getHours(),mi=now.getMinutes(),s=now.getSeconds(),wdJS=now.getDay(); const tS=formatDateTime(yr,mo,d,h,mi,s,wdJS); console.log(`Sending time: ${tS}`); showSpinner("Syncing Pico time..."); const buf=new ArrayBuffer(8); const dV=new DataView(buf); let o=0; dV.setUint16(o,yr,true);o+=2; dV.setUint8(o,mo);o+=1; dV.setUint8(o,d);o+=1; dV.setUint8(o,h);o+=1; dV.setUint8(o,mi);o+=1; dV.setUint8(o,s);o+=1; dV.setUint8(o,wdJS);o+=1; try{await sendCommand(CMD_SET_RTC_TIME,buf); console.log("Time sync cmd sent."); /* Wait for NTF_TIME_UPDATE */ }catch(e){hideSpinner();console.error("Time Sync Error:",e);showToast(`Time Sync Failed: ${e.message}`);} }

    // --- Sensor Control (Manual Refresh) ---
    async function readSensorData() {
        if (!bleDevice || !bleDevice.gatt.connected) return showToast("Not connected.");
        if (!combinedSensorCharacteristic) { showToast("Sensor characteristic not found."); showParsingErrorOnAllSensors('No Char'); return; }
        if (!combinedSensorCharacteristic.properties.read) { showToast("Sensor refresh not supported."); showParsingErrorOnAllSensors('No Read'); return; }
        console.log("Reading combined sensor data..."); showSpinner("Reading sensor data..."); refreshSensorBtn.disabled = true;
        displayTemperature(null, true); updateSensorDisplay(sensorHumidDisplay, 'Reading...', ''); updateSensorDisplay(sensorCO2Display, 'Reading...', ''); updateSensorDisplay(sensorPressureDisplay, 'Reading...', ''); updateSensorDisplay(sensorLuxDisplay, 'Reading...', '');
        let errorMsg = "Sensor read failed";
        try {
            const value = await retryBleOperation(async () => combinedSensorCharacteristic.readValue(), `Combined Sensor Read`, 2, 200);
            if (value instanceof DataView) {
                const decoder = new TextDecoder('utf-8'); const sensorString = decoder.decode(value); const parts = sensorString.split(','); console.log(`Combined Sensor Read Result: "${sensorString}"`);
                if (parts.length === 5) { const tempStr = parts[0]; const tempC = (tempStr === null || tempStr.toUpperCase() === 'N/A' || tempStr.trim() === '') ? null : parseFloat(tempStr); displayTemperature(isNaN(tempC) ? null : tempC); updateSensorDisplay(sensorHumidDisplay, parts[1], '%'); updateSensorDisplay(sensorCO2Display, parts[2], 'ppm'); updateSensorDisplay(sensorPressureDisplay, parts[3], 'hPa'); updateSensorDisplay(sensorLuxDisplay, parts[4], 'lux'); showToast("Sensor data refreshed."); }
                else { console.error(`Combined sensor read string parts error (${parts.length}): "${sensorString}"`); showParsingErrorOnAllSensors('FormatErr'); showToast("Error parsing sensor data format."); }
            } else { console.error("Read combined sensor data returned unexpected type:", value); showParsingErrorOnAllSensors('ReadErr'); showToast("Error reading sensor data type."); }
        } catch (error) {
             console.error("Error reading combined sensor data:", error); showParsingErrorOnAllSensors('ReadErr');
             errorMsg = `Sensor read failed: ${error.message}`; if (error.name === 'NotFoundError') { errorMsg = "Sensor characteristic not found during read."; } else if (error.name === 'NotAllowedError') { errorMsg = "Sensor read not allowed (permissions?)."; } else if (error.name === 'NetworkError') { errorMsg = "Sensor read failed: Disconnected?"; } showToast(errorMsg);
        } finally { hideSpinner(); if (bleDevice && bleDevice.gatt.connected) { refreshSensorBtn.disabled = false; } }
    }

    // --- Run Initialization on Load ---
    document.addEventListener("DOMContentLoaded", initialize);

</script>

</body>
</html>